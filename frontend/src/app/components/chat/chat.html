<div class="chat-container">
  <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
  <div *ngIf="error" class="error-banner">
    <span>{{ error }}</span>
    <button class="error-close" (click)="clearError()">Ã—</button>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ -->
  <div *ngIf="viewMode === 'list'" class="conversations-view">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chat-header">
      <h1>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h1>
      <a routerLink="/dashboard" class="back-btn">
        <span>â†</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      </a>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆä¸€è¦§ -->
    <div *ngIf="!loading" class="conversations-list">
      <div 
        *ngFor="let conversation of conversations; trackBy: trackByConversationId" 
        class="conversation-item"
        (click)="selectConversation(conversation)"
      >
        <div class="conversation-avatar">
          <div class="avatar-container">
            <img 
              *ngIf="getImageUrl(conversation.user.profileImage)" 
              [src]="getImageUrl(conversation.user.profileImage)"
              [alt]="conversation.user.name"
            >
            <div *ngIf="!conversation.user.profileImage" class="default-avatar">
              <span>{{ conversation.user.name?.charAt(0) || '?' }}</span>
            </div>
          </div>
          <span 
            *ngIf="conversation.unreadCount > 0" 
            class="unread-badge"
          >
            {{ conversation.unreadCount > 99 ? '99+' : conversation.unreadCount }}
          </span>
        </div>

        <div class="conversation-content">
          <div class="conversation-header">
            <h3>{{ conversation.user.name }}</h3>
            <span class="conversation-time">
              {{ formatConversationTime(conversation.lastMessage.createdAt) }}
            </span>
          </div>
          
          <div class="conversation-preview">
            <p 
              class="last-message"
              [class.unread]="conversation.unreadCount > 0"
            >
              {{ conversation.lastMessage.content }}
            </p>
          </div>
        </div>

        <div class="conversation-actions">
          <button 
            class="delete-btn"
            (click)="deleteConversation(conversation, $event)"
            title="ä¼šè©±ã‚’å‰Šé™¤"
          >
            ğŸ—‘ï¸
          </button>
        </div>
      </div>

      <!-- ä¼šè©±ãŒãªã„å ´åˆ -->
      <div *ngIf="conversations.length === 0" class="no-conversations">
        <div class="no-conversations-content">
          <h2>ğŸ’¬ ã¾ã ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h2>
          <p>ãƒãƒƒãƒãƒ³ã‚°ã—ã¦æ–°ã—ã„å‡ºä¼šã„ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
          <a routerLink="/matching" class="btn btn-primary">
            ãƒãƒƒãƒãƒ³ã‚°ã‚’å§‹ã‚ã‚‹
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ -->
  <div *ngIf="viewMode === 'conversation'" class="conversation-view">
    <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chat-header">
      <button class="back-btn" (click)="backToList()">
        <span>â†</span> ãƒãƒ£ãƒƒãƒˆä¸€è¦§
      </button>
      
      <div *ngIf="currentUser" class="chat-user-info">
        <div class="avatar-container user-avatar">
          <img 
            *ngIf="getImageUrl(currentUser.profileImage)" 
            [src]="getImageUrl(currentUser.profileImage)"
            [alt]="currentUser.name"
          >
          <div *ngIf="!currentUser.profileImage" class="default-avatar">
            <span>{{ currentUser.name?.charAt(0) || '?' }}</span>
          </div>
        </div>
        <div class="user-details">
          <h2>{{ currentUser.name }}</h2>
          <p>{{ currentUser.prefecture }} {{ currentUser.city }}</p>
        </div>
      </div>

      <button 
        *ngIf="currentUser"
        class="profile-btn"
        (click)="viewProfile(currentUser.id)"
        title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹"
      >
        ğŸ‘¤
      </button>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ -->
    <div 
      *ngIf="!loading" 
      class="messages-container" 
      #messagesContainer
    >
      <div 
        *ngFor="let message of messages; trackBy: trackByMessageId" 
        class="message-wrapper"
        [class.my-message]="isMyMessage(message)"
        [class.other-message]="!isMyMessage(message)"
      >
        <div class="message-bubble">
          <div class="message-content">
            {{ message.content }}
          </div>
          <div class="message-meta">
            <span class="message-time">
              {{ formatMessageTime(message.createdAt) }}
            </span>
            <span 
              *ngIf="isMyMessage(message)" 
              class="read-status"
              [class.read]="message.isRead"
            >
              {{ message.isRead ? 'æ—¢èª­' : 'æœªèª­' }}
            </span>
          </div>
        </div>
      </div>

      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆ -->
      <div *ngIf="messages.length === 0" class="no-messages">
        <div class="no-messages-content">
          <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</h3>
          <p>{{ currentUser?.name }}ã•ã‚“ã¨ã®åˆã‚ã¦ã®ä¼šè©±ã§ã™ã€‚<br>æŒ¨æ‹¶ã‚’ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="message-input-area">
      <div class="input-container">
        <textarea
          #messageInput
          [(ngModel)]="newMessage"
          (keypress)="onKeyPress($event)"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          class="message-input"
          rows="1"
          [disabled]="sending"
        ></textarea>
        
        <button 
          class="send-btn"
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || sending"
          [class.sending]="sending"
        >
          <span *ngIf="!sending">ğŸ“¤</span>
          <span *ngIf="sending" class="loading-spinner small"></span>
        </button>
      </div>
      
      <div class="input-hint">
        <p>Enterã§é€ä¿¡ã€Shift+Enterã§æ”¹è¡Œ</p>
      </div>
    </div>
  </div>
</div>